<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Album</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
  
  <style>
    body {
      overflow-x: hidden;
    }

    .grid-item {
      height: fit-content;
      width: 100%;
      padding: 5px;
    }

    .grid-item img, .grid-item video {
      border-radius: 5px;
    }

    @media screen and (min-width: 960px) {
      .grid-item {
        width: calc(33.33%);
      }
    }
  </style>
</head>
<body>
  <div class="p-1 pt-2">
    <div id="app">
      <div class="text-center" v-if="images.length === 0">
        <button class="btn btn-primary" @click="load">Explore</button>
      </div>
      <isotope :list="images" class="grid d-flex flex-wrap" ref="cpt" :options="options" >
        <div class="grid-item" v-for="image in images" :key="`image-${image.id}`">
          <img :src="image.path" alt="" class="w-100" v-if="image.mime.indexOf('video') !== 0" noevent="true">
          <video :src="image.path" class="w-100" v-if="image.mime.indexOf('video') === 0" loop autoplay muted noevent="true"></video>
        </div>
      </isotope>
    </div>
  </div>
  
  <script src="vue.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
  <script src="vue_isotope.js"></script>
  <script src="https://wzrd.in/standalone/mime@latest"></script>

  <script>
    window.addEventListener('scroll', () => {
      const videos = document.querySelectorAll('.grid-item video[noevent="true"]');
      for (let video of videos){
        video.removeAttribute('noevent');
        video.addEventListener('mouseenter', () => {
          video.muted = false;
        });
        video.addEventListener('mouseleave', () => {
          video.muted = true;
        });
      }

      if (document.documentElement.scrollTop + window.innerHeight >= document.documentElement.scrollHeight - 1000) {
        App.load();
      }
    });

    const RawApp = {
      el: '#app',
      data: {
        images: [],
        allImages: [],
        isLoad: false,
        nextLoad: false,
        page: 0,
        id: 0,
        options: {
          getSortData: {
            id: "id"
          },
          sortBy : "id"
        }
      },
      methods: {
        load(){
          if (this.isLoad){
            this.nextLoad = true;
            return;
          }

          this.isLoad = true;

          this.images.push.apply(
            this.images, 
            this.allImages.slice(this.page * 12, (this.page + 1) * 12)
            .map(img => {
              return Object.assign({}, img, { id: this.id++, mime: mime.getType(img.path) });
            })
          );
          this.page++;

          this.isLoad = false;

          if (this.nextLoad){
            this.nextLoad = false;
            this.load();
          }
        },
        layout () {
          this.$refs.cpt.layout('masonry');
        }     
      },
      async mounted(){
        const res = await axios.get('/images');
        this.allImages.push.apply(this.allImages, res.data);
      }
    };

    const App = new Vue(RawApp);

    setInterval(() => {
      App.layout();
    }, 1000);
  </script>
</body>
</html>